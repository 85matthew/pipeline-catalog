apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: push-image
spec:
  params:
    - name: src-image
      type: string
    - name: dest-image
      type: string
    - name: dest-tags
      type: string
      default: ""
  workspaces:
    - name: source

  steps:
    - name: run-commands
      image: quay.io/skopeo/stable:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        if [ "$(params.dest-tags)" != "" ];
        then
          tags=$(params.dest-tags)
          for i in ${tags//,/ }
          do
            echo "Copying image docker://$(params.src-image) to docker://$(params.dest-image):$i"
            skopeo copy --src-tls-verify=false --dest-tls-verify=false docker://$(params.src-image) docker://$(params.dest-image):$i
            #skopeo copy --src-tls-verify=false --dest-tls-verify=false --src-creds="${USER}:${TOKEN}" --dest-authfile=/workspace/dest/.docker/config.json docker://$(params.src-image) docker://$(params.dest-image):$i
          done
        fi
